// Bangumi smiles emotion
const smiles = { "(bgm10)": "https://bgm.tv/img/smiles/bgm/10.png", "(bgm11)": "https://bgm.tv/img/smiles/bgm/11.gif", "(bgm12)": "https://bgm.tv/img/smiles/bgm/12.png", "(bgm13)": "https://bgm.tv/img/smiles/bgm/13.png", "(bgm14)": "https://bgm.tv/img/smiles/bgm/14.png", "(bgm15)": "https://bgm.tv/img/smiles/bgm/15.png", "(bgm16)": "https://bgm.tv/img/smiles/bgm/16.png", "(bgm17)": "https://bgm.tv/img/smiles/bgm/17.png", "(bgm18)": "https://bgm.tv/img/smiles/bgm/18.png", "(bgm19)": "https://bgm.tv/img/smiles/bgm/19.png", "(bgm20)": "https://bgm.tv/img/smiles/bgm/20.png", "(bgm21)": "https://bgm.tv/img/smiles/bgm/21.png", "(bgm22)": "https://bgm.tv/img/smiles/bgm/22.png", "(bgm23)": "https://bgm.tv/img/smiles/bgm/23.gif", "(bgm24)": "https://bgm.tv/img/smiles/tv/01.gif", "(bgm25)": "https://bgm.tv/img/smiles/tv/02.gif", "(bgm26)": "https://bgm.tv/img/smiles/tv/03.gif", "(bgm27)": "https://bgm.tv/img/smiles/tv/04.gif", "(bgm28)": "https://bgm.tv/img/smiles/tv/05.gif", "(bgm29)": "https://bgm.tv/img/smiles/tv/06.gif", "(bgm30)": "https://bgm.tv/img/smiles/tv/07.gif", "(bgm31)": "https://bgm.tv/img/smiles/tv/08.gif", "(bgm32)": "https://bgm.tv/img/smiles/tv/09.gif", "(bgm33)": "https://bgm.tv/img/smiles/tv/10.gif", "(bgm34)": "https://bgm.tv/img/smiles/tv/11.gif", "(bgm35)": "https://bgm.tv/img/smiles/tv/12.gif", "(bgm36)": "https://bgm.tv/img/smiles/tv/13.gif", "(bgm37)": "https://bgm.tv/img/smiles/tv/14.gif", "(bgm38)": "https://bgm.tv/img/smiles/tv/15.gif", "(bgm39)": "https://bgm.tv/img/smiles/tv/16.gif", "(bgm40)": "https://bgm.tv/img/smiles/tv/17.gif", "(bgm41)": "https://bgm.tv/img/smiles/tv/18.gif", "(bgm42)": "https://bgm.tv/img/smiles/tv/19.gif", "(bgm43)": "https://bgm.tv/img/smiles/tv/20.gif", "(bgm44)": "https://bgm.tv/img/smiles/tv/21.gif", "(bgm45)": "https://bgm.tv/img/smiles/tv/22.gif", "(bgm46)": "https://bgm.tv/img/smiles/tv/23.gif", "(bgm47)": "https://bgm.tv/img/smiles/tv/24.gif", "(bgm48)": "https://bgm.tv/img/smiles/tv/25.gif", "(bgm49)": "https://bgm.tv/img/smiles/tv/26.gif", "(bgm50)": "https://bgm.tv/img/smiles/tv/27.gif", "(bgm51)": "https://bgm.tv/img/smiles/tv/28.gif", "(bgm52)": "https://bgm.tv/img/smiles/tv/29.gif", "(bgm53)": "https://bgm.tv/img/smiles/tv/30.gif", "(bgm54)": "https://bgm.tv/img/smiles/tv/31.gif", "(bgm55)": "https://bgm.tv/img/smiles/tv/32.gif", "(bgm56)": "https://bgm.tv/img/smiles/tv/33.gif", "(bgm57)": "https://bgm.tv/img/smiles/tv/34.gif", "(bgm58)": "https://bgm.tv/img/smiles/tv/35.gif", "(bgm59)": "https://bgm.tv/img/smiles/tv/36.gif", "(bgm60)": "https://bgm.tv/img/smiles/tv/37.gif", "(bgm61)": "https://bgm.tv/img/smiles/tv/38.gif", "(bgm62)": "https://bgm.tv/img/smiles/tv/39.gif", "(bgm63)": "https://bgm.tv/img/smiles/tv/40.gif", "(bgm64)": "https://bgm.tv/img/smiles/tv/41.gif", "(bgm65)": "https://bgm.tv/img/smiles/tv/42.gif", "(bgm66)": "https://bgm.tv/img/smiles/tv/43.gif", "(bgm67)": "https://bgm.tv/img/smiles/tv/44.gif", "(bgm68)": "https://bgm.tv/img/smiles/tv/45.gif", "(bgm69)": "https://bgm.tv/img/smiles/tv/46.gif", "(bgm70)": "https://bgm.tv/img/smiles/tv/47.gif", "(bgm71)": "https://bgm.tv/img/smiles/tv/48.gif", "(bgm72)": "https://bgm.tv/img/smiles/tv/49.gif", "(bgm73)": "https://bgm.tv/img/smiles/tv/50.gif", "(bgm74)": "https://bgm.tv/img/smiles/tv/51.gif", "(bgm75)": "https://bgm.tv/img/smiles/tv/52.gif", "(bgm76)": "https://bgm.tv/img/smiles/tv/53.gif", "(bgm77)": "https://bgm.tv/img/smiles/tv/54.gif", "(bgm78)": "https://bgm.tv/img/smiles/tv/55.gif", "(bgm79)": "https://bgm.tv/img/smiles/tv/56.gif", "(bgm80)": "https://bgm.tv/img/smiles/tv/57.gif", "(bgm81)": "https://bgm.tv/img/smiles/tv/58.gif", "(bgm82)": "https://bgm.tv/img/smiles/tv/59.gif", "(bgm83)": "https://bgm.tv/img/smiles/tv/60.gif", "(bgm84)": "https://bgm.tv/img/smiles/tv/61.gif", "(bgm85)": "https://bgm.tv/img/smiles/tv/62.gif", "(bgm86)": "https://bgm.tv/img/smiles/tv/63.gif", "(bgm87)": "https://bgm.tv/img/smiles/tv/64.gif", "(bgm88)": "https://bgm.tv/img/smiles/tv/65.gif", "(bgm89)": "https://bgm.tv/img/smiles/tv/66.gif", "(bgm90)": "https://bgm.tv/img/smiles/tv/67.gif", "(bgm91)": "https://bgm.tv/img/smiles/tv/68.gif", "(bgm92)": "https://bgm.tv/img/smiles/tv/69.gif", "(bgm93)": "https://bgm.tv/img/smiles/tv/70.gif", "(bgm94)": "https://bgm.tv/img/smiles/tv/71.gif", "(bgm95)": "https://bgm.tv/img/smiles/tv/72.gif", "(bgm96)": "https://bgm.tv/img/smiles/tv/73.gif", "(bgm97)": "https://bgm.tv/img/smiles/tv/74.gif", "(bgm98)": "https://bgm.tv/img/smiles/tv/75.gif", "(bgm99)": "https://bgm.tv/img/smiles/tv/76.gif", "(bgm100)": "https://bgm.tv/img/smiles/tv/77.gif", "(bgm101)": "https://bgm.tv/img/smiles/tv/78.gif", "(bgm102)": "https://bgm.tv/img/smiles/tv/79.gif", "(bgm103)": "https://bgm.tv/img/smiles/tv/80.gif", "(bgm104)": "https://bgm.tv/img/smiles/tv/81.gif", "(bgm105)": "https://bgm.tv/img/smiles/tv/82.gif", "(bgm106)": "https://bgm.tv/img/smiles/tv/83.gif", "(bgm107)": "https://bgm.tv/img/smiles/tv/84.gif", "(bgm108)": "https://bgm.tv/img/smiles/tv/85.gif", "(bgm109)": "https://bgm.tv/img/smiles/tv/86.gif", "(bgm110)": "https://bgm.tv/img/smiles/tv/87.gif", "(bgm111)": "https://bgm.tv/img/smiles/tv/88.gif", "(bgm112)": "https://bgm.tv/img/smiles/tv/89.gif", "(bgm113)": "https://bgm.tv/img/smiles/tv/90.gif", "(bgm114)": "https://bgm.tv/img/smiles/tv/91.gif", "(bgm115)": "https://bgm.tv/img/smiles/tv/92.gif", "(bgm116)": "https://bgm.tv/img/smiles/tv/93.gif", "(bgm117)": "https://bgm.tv/img/smiles/tv/94.gif", "(bgm118)": "https://bgm.tv/img/smiles/tv/95.gif", "(bgm119)": "https://bgm.tv/img/smiles/tv/96.gif", "(bgm120)": "https://bgm.tv/img/smiles/tv/97.gif", "(bgm121)": "https://bgm.tv/img/smiles/tv/98.gif", "(bgm122)": "https://bgm.tv/img/smiles/tv/99.gif", "(bgm123)": "https://bgm.tv/img/smiles/tv/100.gif" }

// @see https://coursesweb.net/javascript/convert-bbcode-html-javascript_cs
// JS function to convert BBCode and HTML code - http;//coursesweb.net/javascript/
function BBCodeHTML() {
    var me = this;            // stores the object instance
    var token_match = /{[A-Z_]+[0-9]*}/ig;

    // regular expressions for the different bbcode tokens
    var tokens = {
      'URL' : '((?:(?:[a-z][a-z\\d+\\-.]*:\\/{2}(?:(?:[a-z0-9\\-._~\\!$&\'*+,;=:@|]+|%[\\dA-F]{2})+|[0-9.]+|\\[[a-z0-9.]+:[a-z0-9.]+:[a-z0-9.:]+\\])(?::\\d*)?(?:\\/(?:[a-z0-9\\-._~\\!$&\'*+,;=:@|]+|%[\\dA-F]{2})*)*(?:\\?(?:[a-z0-9\\-._~\\!$&\'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?(?:#(?:[a-z0-9\\-._~\\!$&\'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?)|(?:www\\.(?:[a-z0-9\\-._~\\!$&\'*+,;=:@|]+|%[\\dA-F]{2})+(?::\\d*)?(?:\\/(?:[a-z0-9\\-._~\\!$&\'*+,;=:@|]+|%[\\dA-F]{2})*)*(?:\\?(?:[a-z0-9\\-._~\\!$&\'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?(?:#(?:[a-z0-9\\-._~\\!$&\'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?)))',
      'LINK' : '([a-z0-9\-\./]+[^"\' ]*)',
      'EMAIL' : '((?:[\\w\!\#$\%\&\'\*\+\-\/\=\?\^\`{\|\}\~]+\.)*(?:[\\w\!\#$\%\'\*\+\-\/\=\?\^\`{\|\}\~]|&)+@(?:(?:(?:(?:(?:[a-z0-9]{1}[a-z0-9\-]{0,62}[a-z0-9]{1})|[a-z])\.)+[a-z]{2,6})|(?:\\d{1,3}\.){3}\\d{1,3}(?:\:\\d{1,5})?))',
      'TEXT' : '((.|\n)*?)', // To cathc \n, fit for bangumi.tv
      'SIMPLETEXT' : '([a-zA-Z0-9-+.,_ ]+)',
      'INTTEXT' : '([a-zA-Z0-9-+,_. ]+)',
      'IDENTIFIER' : '([a-zA-Z0-9-_]+)',
      'COLOR' : '([a-z]+|#[0-9abcdef]+)',
      'NUMBER'  : '([0-9]+)'
    };

    var bbcode_matches = [];        // matches for bbcode to html

    var html_tpls = [];             // html templates for html to bbcode

    var html_matches = [];          // matches for html to bbcode

    var bbcode_tpls = [];           // bbcode templates for bbcode to html

    /**
     * Turns a bbcode into a regular rexpression by changing the tokens into
     * their regex form
     */
    var _getRegEx = function(str) {
      var matches = str.match(token_match);
      var nrmatches = matches.length;
      var i = 0;
      var replacement = '';

      if (nrmatches <= 0) {
        return new RegExp(preg_quote(str), 'g');        // no tokens so return the escaped string
      }

      for(; i < nrmatches; i += 1) {
        // Remove {, } and numbers from the token so it can match the
        // keys in tokens
        var token = matches[i].replace(/[{}0-9]/g, '');

        if (tokens[token]) {
          // Escape everything before the token
          replacement += preg_quote(str.substr(0, str.indexOf(matches[i]))) + tokens[token];

          // Remove everything before the end of the token so it can be used
          // with the next token. Doing this so that parts can be escaped
          str = str.substr(str.indexOf(matches[i]) + matches[i].length);
        }
      }

      replacement += preg_quote(str);      // add whatever is left to the string

      return new RegExp(replacement, 'mgi');
    };

    /**
     * Turns a bbcode template into the replacement form used in regular expressions
     * by turning the tokens in $1, $2, etc.
     */
    var _getTpls = function(str) {
      var matches = str.match(token_match);
      var nrmatches = matches.length;
      var i = 0;
      var replacement = '';
      var positions = {};
      var next_position = 0;

      if (nrmatches <= 0) {
        return str;       // no tokens so return the string
      }

      for(; i < nrmatches; i += 1) {
        // Remove {, } and numbers from the token so it can match the
        // keys in tokens
        var token = matches[i].replace(/[{}0-9]/g, '');
        var position;

        // figure out what $# to use ($1, $2)
        if (positions[matches[i]]) {
          position = positions[matches[i]];         // if the token already has a position then use that
        } else {
          // token doesn't have a position so increment the next position
          // and record this token's position
          next_position += 1;
          position = next_position;
          positions[matches[i]] = position;
        }

        if (tokens[token]) {
          replacement += str.substr(0, str.indexOf(matches[i])) + '$' + position;
          str = str.substr(str.indexOf(matches[i]) + matches[i].length);
        }
      }

      replacement += str;

      return replacement;
    };

    /**
     * Adds a bbcode to the list
     */
    me.addBBCode = function(bbcode_match, bbcode_tpl) {
      // add the regular expressions and templates for bbcode to html
      bbcode_matches.push(_getRegEx(bbcode_match));
      html_tpls.push(_getTpls(bbcode_tpl));

      // add the regular expressions and templates for html to bbcode
      html_matches.push(_getRegEx(bbcode_tpl));
      bbcode_tpls.push(_getTpls(bbcode_match));
    };

    /**
     * Turns all of the added bbcodes into html
     */
    me.bbcodeToHtml = function(str) {
      var nrbbcmatches = bbcode_matches.length;

      /**
       * Fit [code] [/code] for bangumi.tv, reserve content in [code]
       */
      var quoteMatches = str.match(bbcode_matches[0]);
      if (quoteMatches) {
        str = str.replace(bbcode_matches[0], "[code][/code]");
      }

      /* Replace all matches until not replace happen, fit for bangumi.tv
       * @see https://stackoverflow.com/questions/5257000/how-to-know-if-javascript-string-replace-did-anything
       * To see whether replace did anython?
       */
      for(let i=1; i < nrbbcmatches; i += 1) {
        while (str.search(bbcode_matches[i]) >= 0) {
            str = str.replace(bbcode_matches[i], html_tpls[i]);
        }
      }
      /**
       * Replace \n to <br>, fit for bangumi.tv
       * Add <br><br> at the top
       */
      str = str.replace(RegExp('\\n', 'gi'), '<br>')
      str = '<br><br>' + str;

      /**
       * Fit [code] [/code] for bangumi.tv, reserve content in [code]
       */
      if (quoteMatches) {
        var splices = str.split("[code][/code]");
        str = '';
        var j = 0;
        for (; j<quoteMatches.length; ++j) {
          quoteMatches[j] = quoteMatches[j].replace(bbcode_matches[0], html_tpls[0]);
          str += splices[j] + quoteMatches[j];
        }
        if (j < splices.length) {str += splices[j];}
      } 

      /**
       * Fit smiles emotion for bangumi.tv, just replace
       */
      let smileRe = /\(bgm[0-9]+\)/g;
      let smileMatch = str.match(smileRe);
      if (smileMatch) {
        for (let i=0; i<smileMatch.length; ++i) {
          let smileIdx = Number(smileMatch[i].slice(4, -1));
          if (smileIdx >= 10 && smileIdx <= 123) {
            str = str.replaceAll(smileMatch[i], s => `<img src="${smiles[s]}" alt="${s.slice(1,-1)}">`);
          }
        }
      }
      return  str;
    };

    /**
     * Turns html into bbcode
     */
    me.htmlToBBCode = function(str) {
      var nrhtmlmatches = html_matches.length;
      var i = 0;

      for(; i < nrhtmlmatches; i += 1) {
        str = str.replace(html_matches[i], bbcode_tpls[i]);
      }

      return str;
    }

    /**
     * Quote regular expression characters plus an optional character
     * taken from phpjs.org
     */
    function preg_quote (str, delimiter) {
      return (str + '').replace(new RegExp('[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\' + (delimiter || '') + '-]', 'g'), '\\$&');
    }

    // adds BBCodes and their HTML
    me.addBBCode('[code]{TEXT}[/code]', '<div class="codeHighlight"><pre>{TEXT}</pre></div>');
    me.addBBCode('[quote]{TEXT}[/quote]', '<div class="quote"><q>{TEXT}</q></div>');
    me.addBBCode('[b]{TEXT}[/b]', '<strong>{TEXT}</strong>');
    me.addBBCode('[i]{TEXT}[/i]', '<em>{TEXT}</em>');
    me.addBBCode('[u]{TEXT}[/u]', '<span style="text-decoration:underline;">{TEXT}</span>');
    me.addBBCode('[s]{TEXT}[/s]', '<span style="text-decoration:line-through;">{TEXT}</span>');
    me.addBBCode('[url={URL}]{TEXT}[/url]', '<a href="{URL}" target="_blank" rel="nofollow external noopener noreferrer" class="l">{TEXT}</a>');
    me.addBBCode('[url]{URL}[/url]', '<a href="{URL}" target="_blank" rel="nofollow external noopener noreferrer" class="l">{URL}</a>');
    me.addBBCode('[img={NUMBER1},{NUMBER2}]{URL}[/img]', '<img width="{NUMBER1}" height="{NUMBER2}" src="{URL}" class="code" rel="noreferrer" referrerpolicy="no-referrer" alt=""/>');
    me.addBBCode('[img={NUMBER1}x{NUMBER2}]{URL}[/img]', '<img width="{NUMBER1}" height="{NUMBER2}" src="{URL}" class="code" rel="noreferrer" referrerpolicy="no-referrer" alt=""/>');
    me.addBBCode('[img]{URL}[/img]', '<img src="{URL}" class="code" rel="noreferrer" referrerpolicy="no-referrer" alt=""/>');
    me.addBBCode('[color={COLOR}]{TEXT}[/color]', '<span style="color: {COLOR}">{TEXT}</span>');
    me.addBBCode('[size={NUMBER}]{TEXT}[/size]', '<span style="font-size: {NUMBER}pt">{TEXT}</span>');
    me.addBBCode('[mask]{TEXT}[/mask]', '<span style="background-color:#555;color:#555;border:1px solid #555;">{TEXT}</span>');
  };


export { BBCodeHTML as BbcodeParser };        // creates object instance of BBCodeHTML()
