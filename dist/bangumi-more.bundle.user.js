(()=>{"use strict";var t,m={"(bgm10)":"https://bgm.tv/img/smiles/bgm/10.png","(bgm11)":"https://bgm.tv/img/smiles/bgm/11.gif","(bgm12)":"https://bgm.tv/img/smiles/bgm/12.png","(bgm13)":"https://bgm.tv/img/smiles/bgm/13.png","(bgm14)":"https://bgm.tv/img/smiles/bgm/14.png","(bgm15)":"https://bgm.tv/img/smiles/bgm/15.png","(bgm16)":"https://bgm.tv/img/smiles/bgm/16.png","(bgm17)":"https://bgm.tv/img/smiles/bgm/17.png","(bgm18)":"https://bgm.tv/img/smiles/bgm/18.png","(bgm19)":"https://bgm.tv/img/smiles/bgm/19.png","(bgm20)":"https://bgm.tv/img/smiles/bgm/20.png","(bgm21)":"https://bgm.tv/img/smiles/bgm/21.png","(bgm22)":"https://bgm.tv/img/smiles/bgm/22.png","(bgm23)":"https://bgm.tv/img/smiles/bgm/23.gif","(bgm24)":"https://bgm.tv/img/smiles/tv/01.gif","(bgm25)":"https://bgm.tv/img/smiles/tv/02.gif","(bgm26)":"https://bgm.tv/img/smiles/tv/03.gif","(bgm27)":"https://bgm.tv/img/smiles/tv/04.gif","(bgm28)":"https://bgm.tv/img/smiles/tv/05.gif","(bgm29)":"https://bgm.tv/img/smiles/tv/06.gif","(bgm30)":"https://bgm.tv/img/smiles/tv/07.gif","(bgm31)":"https://bgm.tv/img/smiles/tv/08.gif","(bgm32)":"https://bgm.tv/img/smiles/tv/09.gif","(bgm33)":"https://bgm.tv/img/smiles/tv/10.gif","(bgm34)":"https://bgm.tv/img/smiles/tv/11.gif","(bgm35)":"https://bgm.tv/img/smiles/tv/12.gif","(bgm36)":"https://bgm.tv/img/smiles/tv/13.gif","(bgm37)":"https://bgm.tv/img/smiles/tv/14.gif","(bgm38)":"https://bgm.tv/img/smiles/tv/15.gif","(bgm39)":"https://bgm.tv/img/smiles/tv/16.gif","(bgm40)":"https://bgm.tv/img/smiles/tv/17.gif","(bgm41)":"https://bgm.tv/img/smiles/tv/18.gif","(bgm42)":"https://bgm.tv/img/smiles/tv/19.gif","(bgm43)":"https://bgm.tv/img/smiles/tv/20.gif","(bgm44)":"https://bgm.tv/img/smiles/tv/21.gif","(bgm45)":"https://bgm.tv/img/smiles/tv/22.gif","(bgm46)":"https://bgm.tv/img/smiles/tv/23.gif","(bgm47)":"https://bgm.tv/img/smiles/tv/24.gif","(bgm48)":"https://bgm.tv/img/smiles/tv/25.gif","(bgm49)":"https://bgm.tv/img/smiles/tv/26.gif","(bgm50)":"https://bgm.tv/img/smiles/tv/27.gif","(bgm51)":"https://bgm.tv/img/smiles/tv/28.gif","(bgm52)":"https://bgm.tv/img/smiles/tv/29.gif","(bgm53)":"https://bgm.tv/img/smiles/tv/30.gif","(bgm54)":"https://bgm.tv/img/smiles/tv/31.gif","(bgm55)":"https://bgm.tv/img/smiles/tv/32.gif","(bgm56)":"https://bgm.tv/img/smiles/tv/33.gif","(bgm57)":"https://bgm.tv/img/smiles/tv/34.gif","(bgm58)":"https://bgm.tv/img/smiles/tv/35.gif","(bgm59)":"https://bgm.tv/img/smiles/tv/36.gif","(bgm60)":"https://bgm.tv/img/smiles/tv/37.gif","(bgm61)":"https://bgm.tv/img/smiles/tv/38.gif","(bgm62)":"https://bgm.tv/img/smiles/tv/39.gif","(bgm63)":"https://bgm.tv/img/smiles/tv/40.gif","(bgm64)":"https://bgm.tv/img/smiles/tv/41.gif","(bgm65)":"https://bgm.tv/img/smiles/tv/42.gif","(bgm66)":"https://bgm.tv/img/smiles/tv/43.gif","(bgm67)":"https://bgm.tv/img/smiles/tv/44.gif","(bgm68)":"https://bgm.tv/img/smiles/tv/45.gif","(bgm69)":"https://bgm.tv/img/smiles/tv/46.gif","(bgm70)":"https://bgm.tv/img/smiles/tv/47.gif","(bgm71)":"https://bgm.tv/img/smiles/tv/48.gif","(bgm72)":"https://bgm.tv/img/smiles/tv/49.gif","(bgm73)":"https://bgm.tv/img/smiles/tv/50.gif","(bgm74)":"https://bgm.tv/img/smiles/tv/51.gif","(bgm75)":"https://bgm.tv/img/smiles/tv/52.gif","(bgm76)":"https://bgm.tv/img/smiles/tv/53.gif","(bgm77)":"https://bgm.tv/img/smiles/tv/54.gif","(bgm78)":"https://bgm.tv/img/smiles/tv/55.gif","(bgm79)":"https://bgm.tv/img/smiles/tv/56.gif","(bgm80)":"https://bgm.tv/img/smiles/tv/57.gif","(bgm81)":"https://bgm.tv/img/smiles/tv/58.gif","(bgm82)":"https://bgm.tv/img/smiles/tv/59.gif","(bgm83)":"https://bgm.tv/img/smiles/tv/60.gif","(bgm84)":"https://bgm.tv/img/smiles/tv/61.gif","(bgm85)":"https://bgm.tv/img/smiles/tv/62.gif","(bgm86)":"https://bgm.tv/img/smiles/tv/63.gif","(bgm87)":"https://bgm.tv/img/smiles/tv/64.gif","(bgm88)":"https://bgm.tv/img/smiles/tv/65.gif","(bgm89)":"https://bgm.tv/img/smiles/tv/66.gif","(bgm90)":"https://bgm.tv/img/smiles/tv/67.gif","(bgm91)":"https://bgm.tv/img/smiles/tv/68.gif","(bgm92)":"https://bgm.tv/img/smiles/tv/69.gif","(bgm93)":"https://bgm.tv/img/smiles/tv/70.gif","(bgm94)":"https://bgm.tv/img/smiles/tv/71.gif","(bgm95)":"https://bgm.tv/img/smiles/tv/72.gif","(bgm96)":"https://bgm.tv/img/smiles/tv/73.gif","(bgm97)":"https://bgm.tv/img/smiles/tv/74.gif","(bgm98)":"https://bgm.tv/img/smiles/tv/75.gif","(bgm99)":"https://bgm.tv/img/smiles/tv/76.gif","(bgm100)":"https://bgm.tv/img/smiles/tv/77.gif","(bgm101)":"https://bgm.tv/img/smiles/tv/78.gif","(bgm102)":"https://bgm.tv/img/smiles/tv/79.gif","(bgm103)":"https://bgm.tv/img/smiles/tv/80.gif","(bgm104)":"https://bgm.tv/img/smiles/tv/81.gif","(bgm105)":"https://bgm.tv/img/smiles/tv/82.gif","(bgm106)":"https://bgm.tv/img/smiles/tv/83.gif","(bgm107)":"https://bgm.tv/img/smiles/tv/84.gif","(bgm108)":"https://bgm.tv/img/smiles/tv/85.gif","(bgm109)":"https://bgm.tv/img/smiles/tv/86.gif","(bgm110)":"https://bgm.tv/img/smiles/tv/87.gif","(bgm111)":"https://bgm.tv/img/smiles/tv/88.gif","(bgm112)":"https://bgm.tv/img/smiles/tv/89.gif","(bgm113)":"https://bgm.tv/img/smiles/tv/90.gif","(bgm114)":"https://bgm.tv/img/smiles/tv/91.gif","(bgm115)":"https://bgm.tv/img/smiles/tv/92.gif","(bgm116)":"https://bgm.tv/img/smiles/tv/93.gif","(bgm117)":"https://bgm.tv/img/smiles/tv/94.gif","(bgm118)":"https://bgm.tv/img/smiles/tv/95.gif","(bgm119)":"https://bgm.tv/img/smiles/tv/96.gif","(bgm120)":"https://bgm.tv/img/smiles/tv/97.gif","(bgm121)":"https://bgm.tv/img/smiles/tv/98.gif","(bgm122)":"https://bgm.tv/img/smiles/tv/99.gif","(bgm123)":"https://bgm.tv/img/smiles/tv/100.gif"};// @see https://coursesweb.net/javascript/convert-bbcode-html-javascript_cs
function g(){var t=this,g=/{[A-Z_]+[0-9]*}/gi,s={URL:"((?:(?:[a-z][a-z\\d+\\-.]*:\\/{2}(?:(?:[a-z0-9\\-._~\\!$&'*+,;=:@|]+|%[\\dA-F]{2})+|[0-9.]+|\\[[a-z0-9.]+:[a-z0-9.]+:[a-z0-9.:]+\\])(?::\\d*)?(?:\\/(?:[a-z0-9\\-._~\\!$&'*+,;=:@|]+|%[\\dA-F]{2})*)*(?:\\?(?:[a-z0-9\\-._~\\!$&'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?(?:#(?:[a-z0-9\\-._~\\!$&'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?)|(?:www\\.(?:[a-z0-9\\-._~\\!$&'*+,;=:@|]+|%[\\dA-F]{2})+(?::\\d*)?(?:\\/(?:[a-z0-9\\-._~\\!$&'*+,;=:@|]+|%[\\dA-F]{2})*)*(?:\\?(?:[a-z0-9\\-._~\\!$&'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?(?:#(?:[a-z0-9\\-._~\\!$&'*+,;=:@\\/?|]+|%[\\dA-F]{2})*)?)))",LINK:"([a-z0-9-./]+[^\"' ]*)",EMAIL:"((?:[\\w!#$%&'*+-/=?^`{|}~]+.)*(?:[\\w!#$%'*+-/=?^`{|}~]|&)+@(?:(?:(?:(?:(?:[a-z0-9]{1}[a-z0-9-]{0,62}[a-z0-9]{1})|[a-z]).)+[a-z]{2,6})|(?:\\d{1,3}.){3}\\d{1,3}(?::\\d{1,5})?))",TEXT:"((.|\n)*?)",SIMPLETEXT:"([a-zA-Z0-9-+.,_ ]+)",INTTEXT:"([a-zA-Z0-9-+,_. ]+)",IDENTIFIER:"([a-zA-Z0-9-_]+)",COLOR:"([a-z]+|#[0-9abcdef]+)",NUMBER:"([0-9]+)"},i=[],e=[],b=[],v=[],l=function(t){var m=t.match(g),i=m.length,e=0,b="";if(i<=0)return new RegExp(p(t),"g");for(;e<i;e+=1){var v=m[e].replace(/[{}0-9]/g,"");s[v]&&(b+=p(t.substr(0,t.indexOf(m[e])))+s[v],t=t.substr(t.indexOf(m[e])+m[e].length))}return b+=p(t),new RegExp(b,"mgi")},r=function(t){var m=t.match(g),i=m.length,e=0,b="",v={},l=0;if(i<=0)return t;for(;e<i;e+=1){var r,p=m[e].replace(/[{}0-9]/g,"");v[m[e]]?r=v[m[e]]:(r=l+=1,v[m[e]]=r),s[p]&&(b+=t.substr(0,t.indexOf(m[e]))+"$"+r,t=t.substr(t.indexOf(m[e])+m[e].length))}return b+=t};function p(t,m){return(t+"").replace(new RegExp("[.\\\\+*?\\[\\^\\]$(){}=!<>|:\\"+(m||"")+"-]","g"),"\\$&")}t.addBBCode=function(t,m){i.push(l(t)),e.push(r(m)),b.push(l(m)),v.push(r(t))},t.bbcodeToHtml=function(t){var g=i.length,s=t.match(i[0]);s&&(t=t.replace(i[0],"[code][/code]"));for(var b=1;b<g;b+=1)for(;t.search(i[b])>=0;)t=t.replace(i[b],e[b]);if(t="<br><br>"+(t=t.replace(RegExp("\\n","gi"),"<br>")),s){var v=t.split("[code][/code]");t="";for(var l=0;l<s.length;++l)s[l]=s[l].replace(i[0],e[0]),t+=v[l]+s[l];l<v.length&&(t+=v[l])}var r=t.match(/\(bgm[0-9]+\)/g);if(r)for(var p=0;p<r.length;++p){var n=Number(r[p].slice(4,-1));n>=10&&n<=123&&(t=t.replaceAll(r[p],(function(t){return'<img src="'.concat(m[t],'" alt="').concat(t.slice(1,-1),'">')})))}return t},t.htmlToBBCode=function(t){for(var m=b.length,g=0;g<m;g+=1)t=t.replace(b[g],v[g]);return t},t.addBBCode("[code]{TEXT}[/code]",'<div class="codeHighlight"><pre>{TEXT}</pre></div>'),t.addBBCode("[quote]{TEXT}[/quote]",'<div class="quote"><q>{TEXT}</q></div>'),t.addBBCode("[b]{TEXT}[/b]","<strong>{TEXT}</strong>"),t.addBBCode("[i]{TEXT}[/i]","<em>{TEXT}</em>"),t.addBBCode("[u]{TEXT}[/u]",'<span style="text-decoration:underline;">{TEXT}</span>'),t.addBBCode("[s]{TEXT}[/s]",'<span style="text-decoration:line-through;">{TEXT}</span>'),t.addBBCode("[url={URL}]{TEXT}[/url]",'<a href="{URL}" target="_blank" rel="nofollow external noopener noreferrer" class="l">{TEXT}</a>'),t.addBBCode("[url]{URL}[/url]",'<a href="{URL}" target="_blank" rel="nofollow external noopener noreferrer" class="l">{URL}</a>'),t.addBBCode("[img={NUMBER1},{NUMBER2}]{URL}[/img]",'<img width="{NUMBER1}" height="{NUMBER2}" src="{URL}" class="code" rel="noreferrer" referrerpolicy="no-referrer" alt=""/>'),t.addBBCode("[img={NUMBER1}x{NUMBER2}]{URL}[/img]",'<img width="{NUMBER1}" height="{NUMBER2}" src="{URL}" class="code" rel="noreferrer" referrerpolicy="no-referrer" alt=""/>'),t.addBBCode("[img]{URL}[/img]",'<img src="{URL}" class="code" rel="noreferrer" referrerpolicy="no-referrer" alt=""/>'),t.addBBCode("[color={COLOR}]{TEXT}[/color]",'<span style="color: {COLOR}">{TEXT}</span>'),t.addBBCode("[size={NUMBER}]{TEXT}[/size]",'<span style="font-size: {NUMBER}pt">{TEXT}</span>'),t.addBBCode("[mask]{TEXT}[/mask]",'<span style="background-color:#555;color:#555;border:1px solid #555;">{TEXT}</span>')}!function(t){t.BB="bbcode",t.HTML="html",t.MD="markdown"}(t||(t={}));
// ==UserScript==
// @name        Bangumi BBCode Preview
// @namespace   wullic
// @author      Wullic
// @version     0.1
// @description Bangumi BBCode Preview, 在Textarea编辑器里提供预览选项
// @include     /^https?://(bangumi\.tv|bgm\.tv)/?.*/
// @icon        https://bgm.tv/img/favicon.ico
// @grant       GM_info
// @run-at      document.idle
// ==/UserScript==
setTimeout((function(){var m=document.querySelector("#comment_list");function s(m){var s=m.previousElementSibling;if(s){var i=document.createElement("div");i.style.display="none",m.after(i);var e=document.createElement("li"),b=document.createElement("li"),v=document.createElement("a");b.append(v),s.firstChild.append(e,b),v.href="",v.textContent="预览",v.setAttribute("title","BBCode预览"),e.setAttribute("class","markItUpSeparator"),e.textContent="---------------",b.setAttribute("class","markItUpButton markItUpButton16 preview"),b.onclick=function(){return!1},b.addEventListener("click",(function(s){"none"!=m.style.display?(i.innerHTML=function(m,s,i){if(0==m.length)return"";switch(s){case t.BB:if(i===t.HTML)return(new g).bbcodeToHtml(m);case t.HTML:case t.MD:}}(m.value,t.BB,t.HTML).trim(),m.style.display="none",i.style.display="block"):(m.style.display="block",i.style.display="none")})),m.closest("#ReplysForm, #ReplyForm").addEventListener("submit",(function(){m.style.display="block",i.style.display="none"}))}}null==m||m.addEventListener("click",(function(t){var m=t.currentTarget.querySelector("textarea.sub_reply");m&&m==t.target&&m.nextElementSibling.hasAttribute("class")&&setTimeout(s,300,m)})),["textarea#content","textarea#comment","textarea#newbio","textarea#msg_body","textarea#summary"].forEach((function(t){var m=document.querySelector(t);m&&m.addEventListener("focus",(function t(){setTimeout(s,300,m),m.removeEventListener("focus",t)}))}))}),500)})();